name: Auto Update Documentation

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'package.json'
      - 'tsconfig.json'
      - 'typedoc.json'

jobs:
  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.head_ref }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate documentation
      run: npm run docs

    - name: Check for documentation changes
      id: check-changes
      run: |
        if git diff --quiet docs/; then
          echo "has-changes=false" >> $GITHUB_OUTPUT
          echo "📝 No documentation changes detected"
        else
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "📝 Documentation changes detected"
          git diff --name-only docs/
        fi

    - name: Get commit author
      id: get-author
      run: |
        # Get the author of the latest commit
        author=$(git log -1 --pretty=format:'%an')
        author_email=$(git log -1 --pretty=format:'%ae')
        commit_sha=$(git log -1 --pretty=format:'%H')

        echo "author=$author" >> $GITHUB_OUTPUT
        echo "author-email=$author_email" >> $GITHUB_OUTPUT
        echo "commit-sha=$commit_sha" >> $GITHUB_OUTPUT

        # Try to get GitHub username from commit
        github_user=$(gh api "repos/${{ github.repository }}/commits/$commit_sha" --jq '.author.login // empty' 2>/dev/null || echo "")
        if [ -n "$github_user" ] && [ "$github_user" != "null" ]; then
          echo "github-user=$github_user" >> $GITHUB_OUTPUT
          echo "📝 Found GitHub user: $github_user"
        else
          echo "github-user=" >> $GITHUB_OUTPUT
          echo "📝 GitHub user not found for commit author: $author (email: $author_email)"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Commit documentation updates
      if: steps.check-changes.outputs.has-changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/
        git commit -m "docs: auto-update documentation"

    - name: Push documentation updates
      if: steps.check-changes.outputs.has-changes == 'true'
      run: git push origin ${{ github.head_ref }}

    - name: Get current timestamp
      if: steps.check-changes.outputs.has-changes == 'true'
      id: current-time
      run: echo "time=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

    - name: Find existing comment
      if: steps.check-changes.outputs.has-changes == 'true'
      id: find-comment
      uses: peter-evans/find-comment@v3
      with:
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: 'github-actions[bot]'
        body-includes: '<!-- auto-docs-update-comment -->'

    - name: Add success comment to PR
      if: steps.check-changes.outputs.has-changes == 'true'
      uses: peter-evans/create-or-update-comment@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.number }}
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        edit-mode: replace
        body: |
          ## 📚 Documentation Auto-Updated!

          Hey ${{ steps.get-author.outputs.github-user && format('@{0}', steps.get-author.outputs.github-user) || steps.get-author.outputs.author }}! 👋

          I've successfully updated the documentation based on your recent changes.

          ### ✅ Changes Applied
          - 📝 TypeDoc documentation regenerated
          - 🔄 Reflects latest API changes and code comments
          - 📋 Updated files in `docs/` directory

          ### 📊 Details
          - **Triggered by**: Code changes in PR
          - **Based on commit**: `${{ steps.get-author.outputs.commit-sha }}`
          - **Author**: ${{ steps.get-author.outputs.author }}
          - **Updated**: ${{ steps.current-time.outputs.time }}

          The documentation is now up to date with your changes! 🎉

          ---
          *🤖 This comment was automatically generated by the documentation update workflow.*
          <!-- auto-docs-update-comment -->

    - name: Add workflow summary
      run: |
        echo "## 📚 Documentation Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "**PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author**: ${{ steps.get-author.outputs.author }}" >> $GITHUB_STEP_SUMMARY
        echo "**GitHub User**: ${{ steps.get-author.outputs.github-user || 'Not found' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ steps.check-changes.outputs.has-changes }}" == "true" ]]; then
          echo "✅ **Documentation updated successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- 📝 Documentation changes detected and committed" >> $GITHUB_STEP_SUMMARY
          echo "- 🔄 TypeDoc regenerated based on latest code" >> $GITHUB_STEP_SUMMARY
          echo "- � Success comment added to PR" >> $GITHUB_STEP_SUMMARY
          echo "- 👤 Author mentioned in comment" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ **No documentation changes needed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- 📝 No changes detected in generated documentation" >> $GITHUB_STEP_SUMMARY
          echo "- ✨ Documentation is already up to date" >> $GITHUB_STEP_SUMMARY
          echo "- � No PR comment added (no changes)" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files checked:" >> $GITHUB_STEP_SUMMARY
        echo "- TypeDoc generated files in \`docs/\` directory" >> $GITHUB_STEP_SUMMARY
        echo "- Based on source code changes in \`src/\` directory" >> $GITHUB_STEP_SUMMARY
