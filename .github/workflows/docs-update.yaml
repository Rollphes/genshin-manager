name: Auto Update Documentation

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'package.json'
      - 'tsconfig.json'
      - 'typedoc.json'

jobs:
  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.head_ref }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate documentation
      run: npm run docs

    - name: Check for documentation changes
      id: check-changes
      run: |
        if git diff --quiet docs/; then
          echo "has-changes=false" >> $GITHUB_OUTPUT
          echo "ðŸ“ No documentation changes detected"
        else
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Documentation changes detected"
          git diff --name-only docs/
        fi

    - name: Get commit author
      id: get-author
      run: |
        # Get the author of the latest commit
        author=$(git log -1 --pretty=format:'%an')
        author_email=$(git log -1 --pretty=format:'%ae')
        commit_sha=$(git log -1 --pretty=format:'%H')

        echo "author=$author" >> $GITHUB_OUTPUT
        echo "author-email=$author_email" >> $GITHUB_OUTPUT
        echo "commit-sha=$commit_sha" >> $GITHUB_OUTPUT

        # Try to get GitHub username from commit
        github_user=$(gh api "repos/${{ github.repository }}/commits/$commit_sha" --jq '.author.login' 2>/dev/null || echo "")
        if [ -n "$github_user" ]; then
          echo "github-user=$github_user" >> $GITHUB_OUTPUT
        else
          echo "github-user=" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Commit documentation updates
      if: steps.check-changes.outputs.has-changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/
        git commit -m "docs: auto-update documentation

        - Updated TypeDoc generated documentation
        - Reflects latest API changes and code comments
        - Generated from commit ${{ steps.get-author.outputs.commit-sha }}

        Co-authored-by: ${{ steps.get-author.outputs.author }} <${{ steps.get-author.outputs.author-email }}>"

    - name: Push documentation updates
      if: steps.check-changes.outputs.has-changes == 'true'
      run: git push origin ${{ github.head_ref }}

    - name: Add success comment to PR
      if: steps.check-changes.outputs.has-changes == 'true'
      uses: peter-evans/create-or-update-comment@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          ## ðŸ“š Documentation Auto-Updated!

          Hey ${{ steps.get-author.outputs.github-user && format('@{0}', steps.get-author.outputs.github-user) || steps.get-author.outputs.author }}! ðŸ‘‹

          I've successfully updated the documentation based on your recent changes.

          ### âœ… Changes Applied
          - ðŸ“ TypeDoc documentation regenerated
          - ðŸ”„ Reflects latest API changes and code comments
          - ðŸ“‹ Updated files in `docs/` directory

          ### ðŸ“Š Details
          - **Triggered by**: Code changes in PR
          - **Based on commit**: `${{ steps.get-author.outputs.commit-sha }}`
          - **Author**: ${{ steps.get-author.outputs.author }}

          The documentation is now up to date with your changes! ðŸŽ‰

          ---
          *ðŸ¤– This comment was automatically generated by the documentation update workflow.*

    - name: Add workflow summary
      run: |
        echo "## ðŸ“š Documentation Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "**PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author**: ${{ steps.get-author.outputs.author }}" >> $GITHUB_STEP_SUMMARY
        echo "**GitHub User**: ${{ steps.get-author.outputs.github-user || 'Not found' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ steps.check-changes.outputs.has-changes }}" == "true" ]]; then
          echo "âœ… **Documentation updated successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Documentation changes detected and committed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ TypeDoc regenerated based on latest code" >> $GITHUB_STEP_SUMMARY
          echo "- ï¿½ Success comment added to PR" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‘¤ Author mentioned in comment" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **No documentation changes needed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ No changes detected in generated documentation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ¨ Documentation is already up to date" >> $GITHUB_STEP_SUMMARY
          echo "- ï¿½ No PR comment added (no changes)" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files checked:" >> $GITHUB_STEP_SUMMARY
        echo "- TypeDoc generated files in \`docs/\` directory" >> $GITHUB_STEP_SUMMARY
        echo "- Based on source code changes in \`src/\` directory" >> $GITHUB_STEP_SUMMARY
